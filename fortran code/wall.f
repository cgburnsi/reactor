      SUBROUTINE WALL
C                                                                       
C     **************************************************************    
C                                                                       
C	  THIS SUBROUTINE CALCULATES THE BOUNDARY MESH POINTS AT THE NOZZLE
C     WALL, EXHAUST JET BOUNDARY, AND CENTERBODY
C                                                                       
C     **************************************************************    
C                                                                       
      COMMON /AV/ IAV,CAV,NST,SMP,LSS,CTA,XMU,XLA,RKMU,QUT(81,21),QVT(81
     1,21),QPT(81,21)                                                   
      COMMON /ONESID/ UD(4),VD(4),PD(4),ROD(4)                          
      COMMON /SOLUTN/ U(81,21,2),V(81,21,2),P(81,21,2),RO(81,21,2)      
      COMMON /CNTRLC/ LMAX,MMAX,NMAX,NPRINT,TCONV,FDT,GAMMA,RGAS,GAM1,GA
     1M2,L1,L2,L3,M1,M2,DX,DY,DT,N,N1,N3,NASM,IVEL,ICHAR,N1D,LJET,JFLAG,
     2IERR,IUI,IUO,DXR,DYR,LD,MD,LMD1,LMD3,IB,RSTAR,RSTARS,NPLOT,G,PC,TC
     3,LC,PLOW,ROLOW                                                    
      COMMON /GEMTRYC/ NGEOM,XI,RI,XT,RT,XE,RE,RCI,RCT,ANGI,ANGE,XW(81),
     1YW(81),XWI(81),YWI(81),NXNY(81),NWPTS,IINT,IDIF,LT,NDIM           
      COMMON /GCB/ NGCB,XICB,RICB,XTCB,RTCB,XECB,RECB,RCICB,RCTCB,ANGICB
     2,ANGECB,XCB(81),YCB(81),XCBI(81),YCBI(81),NXNYCB(81),NCBPTS,IINTCB
     3,IDIFCB,LECB                                                      
      COMMON /BCC/ PT(21),TT(21),THETA(21),PE,MASSE,MASSI,MASST,THRUST,N
     1STAG                                                              
      REAL MN3,NXNY,MASSI,MASST,NXNYCB,MASSE   
C
	IF (N.EQ.1) DELY=0.005
	XWID=0.0
	IF (IB.EQ.1) GO TO 10
	Y1=0.0 $ Y3=0.0 $ MDUM=1 $ MDUM1=2 $ SIGN=-1.0
	GO TO 20
10	Y1=1.0 $ Y3=1.0 $ MDUM=MMAX $ NDUM1=M1 $ SIGN=1.0
20  ATERM2=0.0
	ATERM3=0.0
	LDUM=LMAX
	IF(ICHAR.EQ.2) LDUM=L1
	LMDM=LD*(MDUM-1)
	LMDM1=LD*(MDUM1-1)
	DYS=SIGN*DYR
	DO 350 L=2,LDUM
	LMN1=L+LMDM+LMD1
	LMN3=L+LMDM+LMD3
	LM1N1=L+LMDM1+LMD1
	L1MN1=L-1+LMDM+LMD1
	L1MN3=L+1+LMDM+LMD3
	L1M1N1=L-1+LMDM1+LMD1
	IF (JFLAG.EQ.0) GO TO 50
	IF (IB.EQ.2) GO TO 50
C
	XWID=WXI(L)
	IF (ICHAR.EQ.1) GO TO 30
C
C	USE THE DUMMY ARRAYS TO MANIPULATE THE ONE-SIDED SOLUTIONS
C
	IF (L.NE.LJET-2) GO TO 30
	U(L1MN3)=UD(3)
	V(L1MN3)=VD(3)
	P(L1MN3)=PD(3)
	RO(L1MN3)=ROD(3)
	GO TO 50
30	IF (L.NE.LJET-1) GO TO 40
	IF (ICHAR.EQ.1) UOLD=U(LMN1)
	U(LMN1)=UD(1)
	V(LMN1)=VD(1)
	P(LMN1)=PD(1)
	RO(LMN1)=ROD(1)
	GO TO 50
40	IF (L.EQ.LJET) GO TO 50
	U(L1MN1)=UD(2)
	V(L1MN1)=VD(2)
	P(L1MN1)=PD(2)
	RO(L1MN1)=ROD(2)
C
50	U1=U(LMN1)
	V1=V(LMN1)
	P1=P(LMN1)
	RO1=RO(LMN1)
	U2=U1
	V2=V1
	A1=SQRT(GAMMA*P1/RO1)
	A2=A1
	IF (ICHAR.EQ.2) GO TO 60
	U3=U1
	V3=V1
	P3=P1
	RO3=RO1
	A3=A1
	GO TO 70
60	U3=U(LMN3)
	V3=V(LMN3)
	P3=P(LMN3)
	RO3=RO(LMN3)
	A3=SQRT(GAMMA*P3/RO3)
C
C	CALCULATE THE PROPERTY INTERPOLATING POLYNOMIAL COEFFICIENTS
C
70	BU=(U1-U(LM1N1))*DYS
	BV=(V1-V(LM1N1))*DYS
	BP=(P1-P(LM1N1))*DYS
	BRO=(RO1-RO(LM1N1))*DYS
	CU=U1-BU*Y3
	CV=V1-BV*Y3
	CP=P1-BP*Y3
	CRO=RO1-BRO*Y3
C
C	CALCULATE THE CROSS DERIVATIVE INTERPOLIATING POLYNOMIAL
C	COEFFICIENTS
C
	DU=(U1-U(L1MN1))*DXR
	DV=(V1-V(L1MN1))*DXR
	DP=(P1-P(L1MN1))*DXR
	DRO=(RO1-RO(L1MN1))*DXR
	DU1=(U(LM1N1)-U(L1M1N1))*DXR
	DV1=(V(LM1N1)-V(L1M1N1))*DXR
	DP1=(P(LM1N1)-P(L1M1N1))*DXR
	DRO1=(RO(LM1N1)-RO(L1M1N1))*DXR
	BDU=(DU-DU1)*DYS
	BDV=(DV-DV1)*DYS
	BDP=(DP-DP1)*DYS
	BDRO=(DRO-DRO1)*DYS
	CDU=DU-BDU*Y3
	CDV=DV-BDV*Y3
	CDP=DP-BDP*Y3
	CDRO=DRO-BDRO*Y3
C
C	CALCULATE Y2
C
	CALL MAP (1,L,MDUM,AL,BEW,DE,LD1,AL1,BE1,DE1)
	ALS=SQRT(AL*AL+BE*BE)
	UV3=U3*AL+V3*BE+DE
	AL2=AL
	DO 90 ILL=1,3
	UV2=U2*AL2+V2*BE+DE
	Y2=Y3-(UV2+SIGN*AL*ALS*A2+UV3+SIGN*ALS*A3)*DT*0.5
C
C 	INTERPOLATE FOR THE PROPERTIES
C
	U2=BU*Y2+CU
	V2=BV*Y2+CV
	P2=BP*Y2+CP
	RO2=BRO*Y2+CRO
	AL2=Y2*AL
	AD=GAMMA*P2/RO2
	IF (AD.GT.0.0) GO TO 80
	PRINT 360, N,L,MDUM
	IERR=1
	RETURN
80	A2=SQRT(AD)
90	CONTINUE
C
C	INTERPOLATE FOR THE CROSS DERIVATIVES
C
	DU1=DU
	DV1=DV
	DP1=DP
	DRO1=DRO
	DU2=BDU*Y2+CDU
	DV2=BDV*Y2+CDV
	DP2=BDP*Y2+CDP
	DRO2=BDRO*Y2+CDRO
C
C	CALCULATE THE PSI TERMS
C
	IF (NDIM.EQ.0) TO TO 110
	IF (IB.EQ.2) GO TO 100
	ATERM2=RO2*V2/(YCB(L)+Y2/BE)
	GO TO 110
100	ATERM2=RO2*V2/(YCB(L)+Y2/BE)
	IF (IAV.EQ.0) GO TO 110
	ATDS=RO2*V(L,2,N1)*DYR*BE
	IF (ABS(ATERM2).GT.ABS(ATDS)) ATERM2=ATDS
C
110	PSI21=-U1*DU1-DP1/RO1
	PSI31=-U1*DV1
	PSI41=-U1*DP1+A1*A1*U1*DRO1
	PSI12=-U2*DRO2-RO2*DU2-ATERM2
	PSI22=-U2*DU2-DP2/RO2
	PSI32=-U2/DV2
	PSI42=-U2*DP2+A2*A2*U2*DRO2
	IF (ICHAR.EQ.1) GO TO 150
C
C 	CALCULATE THE CROSS DERIVATIVES AT THE SOLUTION POINT
C
	IF (JFLAG.EQ.0) GO TO 120
	IF (IB.EQ.2) GO TO 120
	IF (L.EQ.2) GO TO 120
	IF (L.NE.LJET-1) GO TO 120
	IF (ILJET.EQ.2) GO TO 120
	GO TO 130
120	DU3=(U(L1MN3)-U3)*DXR
	DV3=(V(L1MN3)-V3)*DXR
	DP3=(P(L1MN3)-P3)*DXR
	DRO3=(RO(L1MN3)-RO3)*DXR
	GO TO 140
130	DU3=(U3-U(L-1,MDUM,N3))*DXR
	DV3=(V3-V(L-1,MDUM,N3))*DXR
	DP3=(P3-P(L-1,MDUM,N3))*DXR
	DRO3=(RO3-RO(L-1,MDUM,N3))*DXR
C
C	ENTER THE EXHAUST JET ITERATION LOOP
C
140	IF (JFLAG.EQ.0) GO TO 150
	IF (IB.EQ.2) GO TO 150
	IF (L.LT.LJET) GO TO 150
	YWI(L)=YW(L)
	UDUM=U(LMN3)
	VDUM=V(LMN3)
	PDUM=P(LMN3)
	RODUM=RO(LMN3)
150	DO 290 NJ=1,10
	IF (ICAR.EQ.1) GO TO 250
	IF (JFLAG.EQ.0) GO TO 210
	IF (IB.EQ.2) GO TO 210
	IF (L.LT.LJET) GO TO 210
	IF (NJ.EQ.1) GO TO 200
	IF (NJ.GT.2) GO TO 180
160	YWOLD=YW(L)
	POLD=P(LMN3)
	IF (P(LMN3).LT.PE) GO TO 170
	YW(L)=YW(L)+DELY
	GO TO 190
170	YW(L)=YW(L)-DELY
	GO TO 190
180 IF (P(LMN3).EQ.POLD) GO TO 160
	DYDP=(YW(L)-YWOLD)/(P(LMN3)-POLD)
	YWNEW=YW(L)+DYDP*(PE-P(LMN3))
	YWOLD=YW(L)
	POLD=P(LMN3)
	YW(L)=YWNEW
190	IF (YW(L).LT.(0.98*YWOLD)) YW(L)=0.98*YWOLD
	IF (YW(L).GT.(1.02*YWOLD)) YW(L)=1.02*YWOLD
200	NXNY(L)=-(YW(L)-YW(L-1))*DXR
	XWI(L)=(YW(L)-YWI(L)/DT
	XWID=XWI(L)
	CALL MAP (1,L,MDUM,AL,BEW,DE,LD1,AL1,BE1,DE1)
	ALS=SQRT(AL*AL+BE*BE)
	U(LMN3)=UDUM
	V(LMN3)=VDUM
	P(LMN3)=PDUM
	RO(LMN3)=RODUM
C
C	CALCULATE THE PSI TERMS AT THE SOLUTION POINT
C
210	IF (NDIM.EQ.0) GO TO 240
	IF (IB.EQ.2) GO TO 220
	ATERM3=RO3*V2/(YCB(L)+1.0/BE)
	GO TO 240
220 IF (YCB(L).EQ.0.0) GO TO 230
	ATERM3=RO3*V3/YCB(L)
	IF (IAV.EQ.0) GO TO 240
	ATDS=RO3*V(L,2,N3)*DYR*BE
	IF (ABS(ATERM3).GT.ABS(ATDS)) ATERMS=ATDS
	GO TO 240
230	ATERMS=RO3*V(L,2,N3)*DYR*BE
C
240 PSI13=-U3*DRO3-RO3*DU3-ATERM3
	PSI23=-U3*DU3-DP3/RP3
	PSI33=-U3*DV3
	PSI43=-U3*DP3+A3*A3*U3*DRO3
C	CALCULATE THE COMPATIBILITY EQUATION COEFFICIENTS
C
250	ABR=NXNY(L)
	IF (IB.EQ.2) ABR=NXNYCB(L)
	ALB=0.5*(AL2+AL)/ALS
	BEB=BE/ALS
	A1B=(A1+A3)*0.5
	A2B=(A2+A3)*0.5
	RO1B=(RO1+RO3)*0.5
	RO2B=(RO2+RO3)*0.5
	IF (ICAR.eq.1) GO TO 260
	PSI21B=(PSI21+PSI23)*0.5
	PSI31B=(PSI31+PSI33)*0.5
	PSI41B=(PSI41+PSI43)*0.5
	PSI12B=(PSI12+PSI13)*0.5
	PSI22B=(PSI22+PSI23)*0.5
	PSI32B=(PSI32+PSI33)*0.5
	PSI42B=(PSI42+PSI43)*0.5
	GO TO 270
260	PSI21B=PSI21
	PSI31B=PSI31
	PSI41B=PSI41
	PSI12B=PSI12
	PSI12B=PSI12
	PSI22B=PSI22
	PSI32B=PSI32
	PSI42B=PSI42
C
C	SOLVE THE COMPATIBILITY EQUATIONS FOR U,V,P, AND RO
C
270	U(LMN3)=(U(LMN1)-ABR*(V(LMN1)-XWID)+(PSI21B-ABR*PSI31B)*DT)/(1.0+A
   1BR*ABR)
	V(LMN3)=-U(LMN3)*ABR+XWID
	P(LMN3)=P2-SIGN*RO2B*A2B*(ALB*(U(LMN3)-U2)+BEB*(V(LMN3)-V2))+(PSI4
   22B+A2B*A2B*PSI12B+SIGN*RO2B*A2B*(ALB*PSI22B+BEB*PSI32B))*DT
	IF (P(LMN3).LE.0.0) P(LMN3)=PLOW*PC
	RO(LMN3)=RO(LMN1)+(P(LMN3)-P(LMN1)-PSI41B*DT)/(A1B**A1B)
	IF (RO(LMN3).LE.0.0) RO(LMN3)=ROLOW/G
	IF (IAV.EQ.0) GO TO 280
C
C	ADD THE ARTIFICAL VISCOSITY FOR SHOCK CALCULATIONS
C
	IF (ICHAR.EQ.1) GO TO 280
	U(LMN3)=U(LMN3)+(QUT(L,MDUM)-ABR*QVT(L,MDUM))/(1.0+ABR*ABR)
	V(LMN3)=-U(LMN3)*ABR
	P(LMN3)=P(LMN3)+QPT(L,MDUM)
280	IF (JFLAG.EQ.0) GO TO 350
	IF (IB.EQ.2) GO TO 350
	IF (L.LT.LJET-1) GO TO 350
	IF (L.EQ.LJET-1) GO TO 300
	IF (ICHAR.EQ.1) GO TO 350
	DELP=ABS((P(LMN3)-PE)/PE)
	IF (DELP.LE.0.001) GO TO 350
290 CONTINUE
	GO TO 350
C
C	SOLVE THE COMPATIBILITY EQUATIONS FOR THE DOWNSTREAM SIDE OF THE
C	NOZZLE WALL EXIT POINT
C
300 UD(3)=U(LMN3)
	VD(3)=V(LMN3)
	PD(3)=P(LMN3)
	ROD(3)=RO(LMN3)
	PD(4)=PE
	XM1=SQRT((UD(3)*UD(3)+VD(3)*VD(3))/(GAMMA*PD(3)/ROD(3)))
	DUMD=1.0+GAM2*XM1*XM1
	TD=PD(3)/ROD(3)/RGAS/G
	TTD=TD*DUMD
	IF (PE.GT.PD(3).AND.XM1.GE.1.0) GO TO 310
	TTD=TD*DUMD
	IF (PE.GT.PD(3).AND.XM1.GE.1.0) GO TO 310
	PTD=PD(3)*DUMD**GAM1
	ROD(4)=ROD(3)*(PE/PD(3))**(1.0/GAMMA)
	GO TO 320
310	PRD=PE/PD(3)
	GAMD=(GAMMA+1.0)/(GAMMA-1.0)
	ROD(4)=ROD(3)*(GAMD*PRD+1.0)/(PRD+GAMD)
320	TE=PE/ROD(4)/RGAS/G
	XMACH=SQRT((TTD/TE-1.0)/GAM2)
	SS=SQRT(GAMMA*PE/ROD(4))
	VMAG=XMACH*SS
	UD(4)=VMAG/SQRT(1.0+NXNY(LJET)*NXNY(LJET))
	VD(4)=-UD(4)*NXNY(LJET)
C
C	AVERAGE THE 1-SIDED MACH NOS FOR THE INTERIOR POINT CALCULATIONS
C
	XM2=SQRT((UD(4)*UD(4)+vD(4)*VD(4)/(GAMMA*PD(4)/ROD(4)))
	IF (XM1.GE.1.0) GO TO 350
	XMB=(XM1+XM2)/2.0
	IF (XMB.GE.1.0) GO TO 330
	DPL=1.0
	DPR=1.0
	GO TO 340
330	DPL=XM2-1.0
	DPR=1.0-XM1
	XMB=1.0
340	DPLR=DPR+DPL
	DUM=1.0+GAM2*XMB*XMB
	TEMP=TTD/DUM
	P(LMN3)=PTD/DUM**GAM1
	RO(LMN3)=P(LMN3)/(RGAS*TEMP*G)
	QA=SQRT(2.0*GAM1*(RGAS*TTD*G-P(LMN3)/RO(LMN3)))
	DNXNY=(DPR*NXNY(LJET)+DPL*NXNY(L))/DPLR
	U(LMN3)=QA/SQRT(1.0+DNXNY*DNXNY)
	V(LMN3)=-U(LMN3)*DNXNY
	IF (ICHAR.EQ.1) GO TO 350
	UD(1)=UD(3)
	VD(1)=VD(3)
	PD(1)=PD(3)
	ROD(1)=ROD(3)
	UD(2)=UD(4)
	VD(2)=VD(4)
	PD(2)=PD(4)
	ROD(2)=ROD(4)
350	CONTINUE
	IF (JFLAG.EQ.0) RETURN
	IF (IB.EQ.2) RETURN
	IF (ICHAR.EQ.l) RETURN
	U(LJET-1,MMAX,Nl)=UOLD
	YWI(LMAX)=YW(LMAX)
	YW(LMAX)=2.0*YW(L1)-YW(L2)
	NXNY(LMAX)=-(YW(LMAX)-YW(L1))*DXR
	XWI(LMAX=(YW(LMAX)-YWI(LMAX))/DT
	DELY=ABS(YW(LJET)-YWI(LJET)))
	IF (DELY.EQ.0.0) DELY=0.0001
	RETURN
C
360	FORMAT (1H0,61H***** A NEGATIVE QUARE ROOT OCCURED IN SUBROUTINE
   1WALL AT N=,I4,4H, L=,I2,8H, AND M=,I2,6H *****)
	END


